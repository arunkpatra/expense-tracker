<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:sec="http://www.springframework.org/security/tags"
	template="/WEB-INF/layouts/standard.xhtml">

	<ui:define name="content">
		<h2>Payments</h2>
		<h:form id="mainForm">
			<p:messages id="messages" autoUpdate="true" closable="true" />
			<!-- USER ONLY PAGE -->
			<sec:authorize ifNotGranted="ROLE_SUPERVISOR,ROLE_SITE_ADMIN">
				<h:outputText id="noShareText"
					value="No outstanding payments or receipts for you."
					rendered="#{userPayments.rowCount == 0}" />
				<h:dataTable id="shares" styleClass="summary"
					value="#{userPayments}" var="up"
					rendered="#{userPayments.rowCount > 0}">
					<h:column>
						<f:facet name="header">
							<h:outputText value="Sttlmt. Id"></h:outputText>
						</f:facet>
						<a
							href="${request.contextPath}/et/settlementSubReport.pdf?sid=#{up.settlementId}"
							target="blank"> #{up.settlementId} </a>
					</h:column>
					<h:column>
						<f:facet name="header">
							<h:outputText value="Exp. Report">
							</h:outputText>
						</f:facet>
						<div class="output" align="center">
							<a
								href="${request.contextPath}/et/expenseReport.pdf?sid=#{up.settlementId}"
								target="blank"> <img
								src="${request.contextPath}/images/pdficon_small.gif"
								alt="Exp. Report" />
							</a>
						</div>
					</h:column>
					<h:column>
						<f:facet name="header">
							<h:outputText value="Amount"></h:outputText>
						</f:facet>
						<div class="output">
							<h:outputText value="#{up.amount}">
								<f:convertNumber minFractionDigits="2" maxFractionDigits="2" />
							</h:outputText>
						</div>
					</h:column>
					<h:column>
						<f:facet name="header">
							<h:outputText value="Start Date"></h:outputText>
						</f:facet>
						<div class="output">
							<h:outputText value="#{up.startDate}">
								<f:convertDateTime dateStyle="short" timeZone="EST"
									pattern="MM/dd/yyyy" />
							</h:outputText>
						</div>
					</h:column>
					<h:column>
						<f:facet name="header">
							<h:outputText value="End Date"></h:outputText>
						</f:facet>
						<div class="output">
							<h:outputText value="#{up.endDate}">
								<f:convertDateTime dateStyle="short" timeZone="EST"
									pattern="MM/dd/yyyy" />
							</h:outputText>
						</div>
					</h:column>
					<h:column>
						<f:facet name="header">
							<h:outputText value="Payment"></h:outputText>
						</f:facet>
						<!-- If user has debit -->
						<h:outputText value="Not Paid"
							rendered="#{(up.settledFlag == 0) and (up.amount lt 0)}"
							style="font-weight: bold; color: red" />
						<h:outputText value="Paid"
							rendered="#{(up.settledFlag == 1) and (up.amount lt 0)}" />
						<!-- If user has credit -->
						<h:outputText value="Recieved"
							rendered="#{(up.settledFlag == 1) and (up.amount >= 0)}" />
						<h:outputText value="Pending"
							rendered="#{(up.settledFlag == 0) and (up.amount >= 0)}"
							style="font-weight: bold; color: red" />
					</h:column>
				</h:dataTable>
			</sec:authorize>


			<!-- ********************************************************************************************* -->
			<!-- SUPERVISOR ONLY SCREEN -->
			<sec:authorize ifAnyGranted="ROLE_SUPERVISOR,ROLE_SITE_ADMIN">
				<p:fieldset id="paymentDetailsTable1" legend="Payments">
					<h:outputText id="noShareText1"
						value="No outstanding payments or receipts for any user."
						rendered="#{allPayments.rowCount == 0}" />
					<p:dataTable id="shares1" value="#{allPayments}" var="ap"
						rendered="#{allPayments.rowCount > 0}">
						<p:column headerText="Sttlmt. Id">
							<a
								href="${request.contextPath}/et/settlementSubReport.pdf?sid=#{ap.settlementId}"
								target="blank"> #{ap.settlementId} </a>
						</p:column>
						<p:column headerText="Exp. Report">
							<a
								href="${request.contextPath}/et/expenseReport.pdf?sid=#{ap.settlementId}"
								target="blank"> <img
								src="${request.contextPath}/images/pdficon_small.gif"
								alt="Exp. Report" />
							</a>
						</p:column>
						<p:column headerText="User">
							<h:outputText value="#{ap.userName}" />
						</p:column>
						<p:column headerText="Amt.">
							<h:outputText value="#{ap.amount}">
								<f:convertNumber maxFractionDigits="2" />
							</h:outputText>
						</p:column>
						<p:column headerText="Start Date">
							<h:outputText value="#{ap.startDate}">
								<f:convertDateTime dateStyle="short" timeZone="EST"
									pattern="MM/dd/yyyy" />
							</h:outputText>
						</p:column>
						<p:column headerText="End Date">
							<h:outputText value="#{ap.endDate}">
								<f:convertDateTime dateStyle="short" timeZone="EST"
									pattern="MM/dd/yyyy" />
							</h:outputText>
						</p:column>
						<p:column headerText="Status">
							<h:outputText value="Settled" rendered="#{(ap.settledFlag == 1)}" />
							<h:outputText value="Pending" rendered="#{(ap.settledFlag == 0)}" />
						</p:column>
						<p:column headerText="Action">
							<!-- This action will settle this record. Admin must recieve paper money from user first -->
							<p:commandButton id="moneyPaidByUser" value="Recieve"
								processIds="*" action="settleTransaction"
								oncomplete="confirmDialog.show()"
								rendered="#{(ap.settledFlag == 0) and (ap.amount lt 0)}">
								<f:param name="userSettlementId" value="#{ap.userSettlementId}" />
							</p:commandButton>

							<p:commandButton id="paid" value="Disburse" processIds="*"
								action="settleTransaction" oncomplete="confirmDialog.show()"
								rendered="#{(ap.settledFlag == 0) and (ap.amount gt 0)}">
								<f:param name="userSettlementId" value="#{ap.userSettlementId}" />
							</p:commandButton>
						</p:column>
					</p:dataTable>
				</p:fieldset>
				<p:dialog widgetVar="confirmDialog" id="dlg1"
					header="Payment Confirmation" modal="true" width="300">
					<p:outputPanel id="confirmContent">
						<p:messages id="messages1" autoUpdate="true" closable="true" />
						<p>Transaction completed successfully.</p>
						<p:commandButton id="ok" value="Ok" action="ok"
							update="paymentDetailsTable1" />
					</p:outputPanel>
				</p:dialog>
			</sec:authorize>

		</h:form>
	</ui:define>
</ui:composition>